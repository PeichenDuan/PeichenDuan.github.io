<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®‹åŸºæœ€çŸ­è·¯å¾„ï¼ˆSPMï¼‰è®¡ç®—</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .tool-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            width: 100%;
            text-align: center;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            margin-top: 15px;
            text-decoration: none;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* å†…å®¹åŒºåŸŸæ ·å¼ */
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        h2 {
            color: var(--primary-color);
            text-align: center;
        }

        h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .file-upload:hover {
            border-color: var(--secondary-color);
            background-color: #f9f9f9;
        }

        .file-upload.drag-over {
            border-color: var(--success-color);
            background-color: #e8f8f0;
        }

        .file-upload.has-file {
            border-color: var(--success-color);
            background-color: #e8f8f0;
        }

        .file-upload input {
            display: none;
        }

        .upload-icon {
            font-size: 2rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .file-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .file-selected {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--secondary-color);
        }

        .file-selected-name {
            font-weight: 600;
            color: var(--primary-color);
            display: block;
            margin-bottom: 5px;
        }

        .file-selected-size {
            font-size: 0.85rem;
            color: #666;
        }

        .file-list {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: var(--border-radius);
            max-height: 150px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            font-weight: 500;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .file-size {
            color: #777;
            font-size: 0.85rem;
        }

        .remove-file {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 10px;
        }

        .remove-file:hover {
            background-color: #c0392b;
        }

        /* æŒ‰é’®æ ·å¼ */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .primary-button, .secondary-button {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            flex: 1;
        }

        .primary-button {
            background-color: var(--secondary-color);
            color: white;
        }

        .primary-button:hover {
            background-color: #2980b9;
        }

        .primary-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .secondary-button {
            background-color: var(--accent-color);
            color: white;
        }

        .secondary-button:hover {
            background-color: #c0392b;
        }

        /* å‚æ•°è®¾ç½®æ ·å¼ */
        .parameter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .parameter-item {
            display: flex;
            flex-direction: column;
        }

        .parameter-item label {
            margin-bottom: 5px;
        }

        /* ç»“æœåŒºåŸŸæ ·å¼ */
        .result-box {
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            margin-top: 15px;
            border-left: 4px solid var(--secondary-color);
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            margin-top: 20px;
        }

        .progress-bar {
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
        }

        /* æ—¥å¿—è¾“å‡ºæ ·å¼ */
        .log-output {
            padding: 15px;
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: var(--border-radius);
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* çŠ¶æ€æ æ ·å¼ */
        .status-bar {
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
        }

        /* ç»“æœæ–‡ä»¶åˆ—è¡¨æ ·å¼ */
        .result-files {
            margin-top: 20px;
        }

        .file-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: white;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .file-card:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .download-btn {
            padding: 5px 10px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .download-btn:hover {
            background-color: #2980b9;
        }

        /* å…¨è¡ŒæŒ‰é’®æ ·å¼ */
        .full-width-button {
            width: 100%;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .parameter-group {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="tool-header">
        <h2 style="color: white;">æ®‹åŸºæœ€çŸ­è·¯å¾„ï¼ˆSPMï¼‰è®¡ç®—</h2>
        <a href="index.html" class="back-button">è¿”å›ä¸»ç•Œé¢</a>
    </div>
    
    <div class="content">
        <!-- æ–‡ä»¶ä¸Šä¼ éƒ¨åˆ† -->
        <div class="section">
            <h2>è¾“å…¥æ–‡ä»¶</h2>
            <p style="text-align: center; margin-bottom: 20px; color: #666;">
                è¯·ä¸Šä¼ æ‰€éœ€æ–‡ä»¶ä»¥è¿›è¡Œæ®‹åŸºæœ€çŸ­è·¯å¾„ï¼ˆSPMï¼‰è®¡ç®—ã€‚è®¡ç®—å®Œæˆåå°†ç”ŸæˆåŒ…å«ç»“æœæ–‡ä»¶çš„ZIPåŒ…ã€‚
            </p>
            
            <div class="form-group">
                <label for="pdb-file">PDBç»“æ„æ–‡ä»¶ (.pdb)</label>
                <div class="file-upload" id="pdb-upload">
                    <div class="upload-icon">ğŸ“</div>
                    <div>ç‚¹å‡»é€‰æ‹©PDBæ–‡ä»¶æˆ–æ‹–æ”¾è‡³æ­¤</div>
                    <input type="file" id="pdb-file" accept=".pdb">
                    <div class="file-info">ç”¨äºç”ŸæˆPyMOLè„šæœ¬çš„å‚è€ƒç»“æ„</div>
                    <div class="file-selected" id="pdb-selected" style="display: none;">
                        <span class="file-selected-name" id="pdb-filename"></span>
                        <span class="file-selected-size" id="pdb-filesize"></span>
                    </div>
                </div>
                <div id="pdb-list" class="file-list"></div>
            </div>
            
            <div class="form-group">
                <label for="dist-file">è·ç¦»çŸ©é˜µæ–‡ä»¶ (.npy, .txt, .dat)</label>
                <div class="file-upload" id="dist-upload">
                    <div class="upload-icon">ğŸ“Š</div>
                    <div>ç‚¹å‡»é€‰æ‹©è·ç¦»çŸ©é˜µæ–‡ä»¶æˆ–æ‹–æ”¾è‡³æ­¤</div>
                    <input type="file" id="dist-file" accept=".npy,.txt,.dat,.csv">
                    <div class="file-info">æ®‹åŸºé—´è·ç¦»çŸ©é˜µï¼ˆNÃ—Næ–¹é˜µï¼‰</div>
                    <div class="file-selected" id="dist-selected" style="display: none;">
                        <span class="file-selected-name" id="dist-filename"></span>
                        <span class="file-selected-size" id="dist-filesize"></span>
                    </div>
                </div>
                <div id="dist-list" class="file-list"></div>
            </div>
            
            <div class="form-group">
                <label for="corr-file">ç›¸å…³çŸ©é˜µæ–‡ä»¶ (.npy, .txt, .dat)</label>
                <div class="file-upload" id="corr-upload">
                    <div class="upload-icon">ğŸ“ˆ</div>
                    <div>ç‚¹å‡»é€‰æ‹©ç›¸å…³çŸ©é˜µæ–‡ä»¶æˆ–æ‹–æ”¾è‡³æ­¤</div>
                    <input type="file" id="corr-file" accept=".npy,.txt,.dat,.csv">
                    <div class="file-info">æ®‹åŸºé—´ç›¸å…³æ€§çŸ©é˜µï¼ˆNÃ—Næ–¹é˜µï¼‰</div>
                    <div class="file-selected" id="corr-selected" style="display: none;">
                        <span class="file-selected-name" id="corr-filename"></span>
                        <span class="file-selected-size" id="corr-filesize"></span>
                    </div>
                </div>
                <div id="corr-list" class="file-list"></div>
            </div>
        </div>
        
        <!-- å‚æ•°è®¾ç½®éƒ¨åˆ† -->
        <div class="section">
            <h2>è®¡ç®—å‚æ•°</h2>
            
            <div class="parameter-group">
                <div class="parameter-item">
                    <label for="threshold">è·ç¦»é˜ˆå€¼ (Ã…)</label>
                    <input type="number" id="threshold" value="6.0" step="0.1" min="0.1" max="100">
                    <small>æ®‹åŸºé—´è·ç¦»è¶…è¿‡æ­¤å€¼å°†è¢«å¿½ç•¥</small>
                </div>
                
                <div class="parameter-item">
                    <label for="significance">æ˜¾è‘—æ€§é˜ˆå€¼ (0-1)</label>
                    <input type="number" id="significance" value="0.3" step="0.05" min="0" max="1">
                    <small>è¾¹ä½¿ç”¨åˆ†æ•°é˜ˆå€¼ï¼Œé«˜äºæ­¤å€¼çš„è¾¹å°†è¢«ä¿ç•™</small>
                </div>
                
                <div class="parameter-item">
                    <label for="epsilon">æå°å€¼ (Îµ)</label>
                    <input type="number" id="epsilon" value="0.000001" step="0.000001" min="0.0000001">
                    <small>é¿å…log(0)çš„æå°å€¼</small>
                </div>
            </div>
        </div>
        
        <!-- è®¡ç®—æ§åˆ¶éƒ¨åˆ† -->
        <div class="section">
            <h2>è®¡ç®—æ§åˆ¶</h2>
            
            <div class="button-group">
                <button id="calculate-btn" class="primary-button">å¼€å§‹è®¡ç®—</button>
                <button id="reset-btn" class="secondary-button">é‡ç½®æ‰€æœ‰</button>
            </div>
            
            <div class="progress-container" id="progress-container" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">å‡†å¤‡ä¸­...</div>
            </div>
            
            <div class="log-output" id="log-output" style="display: none;"></div>
        </div>
        
        <!-- ç»“æœè¾“å‡ºéƒ¨åˆ† -->
        <div class="section" id="results-section" style="display: none;">
            <h2>è®¡ç®—ç»“æœ</h2>
            
            <div class="result-box">
                <p><strong>è®¡ç®—å®Œæˆï¼</strong> å·²ç”Ÿæˆä»¥ä¸‹ç»“æœæ–‡ä»¶ï¼š</p>
                
                <div class="result-files" id="result-files"></div>
                
                <button id="download-all-btn" class="primary-button full-width-button">ä¸‹è½½æ‰€æœ‰æ–‡ä»¶(ZIP)</button>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        æ±Ÿå—å¤§å­¦ ç²®é£Ÿå‘é…µå·¥è‰ºä¸æŠ€æœ¯å›½å®¶å·¥ç¨‹å®éªŒå®¤
    </div>

    <!-- å¼•å…¥JSZipåº“ç”¨äºåˆ›å»ºZIPæ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- å¼•å…¥FileSaver.jsç”¨äºä¿å­˜æ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ–‡ä»¶ä¸Šä¼ å¤„ç†
            const fileUploads = [
                { 
                    id: 'pdb-file', 
                    uploadDiv: 'pdb-upload', 
                    listDiv: 'pdb-list',
                    selectedDiv: 'pdb-selected',
                    filenameDiv: 'pdb-filename',
                    filesizeDiv: 'pdb-filesize'
                },
                { 
                    id: 'dist-file', 
                    uploadDiv: 'dist-upload', 
                    listDiv: 'dist-list',
                    selectedDiv: 'dist-selected',
                    filenameDiv: 'dist-filename',
                    filesizeDiv: 'dist-filesize'
                },
                { 
                    id: 'corr-file', 
                    uploadDiv: 'corr-upload', 
                    listDiv: 'corr-list',
                    selectedDiv: 'corr-selected',
                    filenameDiv: 'corr-filename',
                    filesizeDiv: 'corr-filesize'
                }
            ];
            
            // æ–‡ä»¶å­˜å‚¨
            const uploadedFiles = {
                'pdb-file': null,
                'dist-file': null,
                'corr-file': null
            };
            
            // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            fileUploads.forEach(item => {
                const uploadDiv = document.getElementById(item.uploadDiv);
                const fileInput = document.getElementById(item.id);
                const listDiv = document.getElementById(item.listDiv);
                const selectedDiv = document.getElementById(item.selectedDiv);
                const filenameDiv = document.getElementById(item.filenameDiv);
                const filesizeDiv = document.getElementById(item.filesizeDiv);
                
                // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
                uploadDiv.addEventListener('click', () => fileInput.click());
                
                // æ–‡ä»¶é€‰æ‹©å˜åŒ–
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        handleFileUpload(file, item, uploadDiv, selectedDiv, filenameDiv, filesizeDiv);
                    }
                });
                
                // æ‹–æ”¾åŠŸèƒ½
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadDiv.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                // é«˜äº®æ‹–æ”¾åŒºåŸŸ
                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadDiv.addEventListener(eventName, () => {
                        uploadDiv.classList.add('drag-over');
                    }, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    uploadDiv.addEventListener(eventName, () => {
                        uploadDiv.classList.remove('drag-over');
                    }, false);
                });
                
                // å¤„ç†æ–‡ä»¶æ‹–æ”¾
                uploadDiv.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        const file = files[0];
                        handleFileUpload(file, item, uploadDiv, selectedDiv, filenameDiv, filesizeDiv);
                        fileInput.files = files; // æ›´æ–°æ–‡ä»¶è¾“å…¥
                    }
                }, false);
            });
            
            // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
            function handleFileUpload(file, item, uploadDiv, selectedDiv, filenameDiv, filesizeDiv) {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                const fileExt = file.name.split('.').pop().toLowerCase();
                const allowedExtensions = {
                    'pdb-file': ['pdb'],
                    'dist-file': ['npy', 'txt', 'dat', 'csv'],
                    'corr-file': ['npy', 'txt', 'dat', 'csv']
                };
                
                const allowed = allowedExtensions[item.id];
                if (!allowed || !allowed.includes(fileExt)) {
                    let errorMsg = `æ–‡ä»¶ç±»å‹ä¸æ”¯æŒã€‚`;
                    if (item.id === 'pdb-file') {
                        errorMsg += ' è¯·ä¸Šä¼ .pdbæ–‡ä»¶ã€‚';
                    } else {
                        errorMsg += ' è¯·ä¸Šä¼ .npy, .txt, .datæˆ–.csvæ–‡ä»¶ã€‚';
                    }
                    alert(errorMsg);
                    return;
                }
                
                // å­˜å‚¨æ–‡ä»¶
                uploadedFiles[item.id] = file;
                
                // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸçš„åé¦ˆ
                uploadDiv.classList.add('has-file');
                
                // æ›´æ–°æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶ä¿¡æ¯
                filenameDiv.textContent = file.name;
                filesizeDiv.textContent = formatFileSize(file.size);
                selectedDiv.style.display = 'block';
                
                // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
                updateFileList(file, item.id, document.getElementById(item.listDiv));
                
                // æ—¥å¿—
                logMessage(`å·²ä¸Šä¼ æ–‡ä»¶: ${file.name} (${formatFileSize(file.size)})`);
            }
            
            // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
            function updateFileList(file, inputId, listDiv) {
                const element = document.getElementById(listDiv);
                const fileSize = formatFileSize(file.size);
                
                element.innerHTML = `
                    <div class="file-item">
                        <div class="file-name" title="${file.name}">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                        <button class="remove-file" data-input="${inputId}">Ã—</button>
                    </div>
                `;
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
                const removeBtn = element.querySelector('.remove-file');
                removeBtn.addEventListener('click', function() {
                    // ç§»é™¤æ–‡ä»¶
                    uploadedFiles[inputId] = null;
                    document.getElementById(inputId).value = '';
                    element.innerHTML = '';
                    
                    // ç§»é™¤ä¸Šä¼ åŒºåŸŸçš„åé¦ˆ
                    const uploadDivId = inputId.replace('-file', '-upload');
                    const selectedDivId = inputId.replace('-file', '-selected');
                    
                    document.getElementById(uploadDivId).classList.remove('has-file');
                    document.getElementById(selectedDivId).style.display = 'none';
                    
                    logMessage(`å·²ç§»é™¤æ–‡ä»¶: ${file.name}`);
                });
            }
            
            // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('reset-btn').addEventListener('click', function() {
                // é‡ç½®æ–‡ä»¶è¾“å…¥
                document.getElementById('pdb-file').value = '';
                document.getElementById('dist-file').value = '';
                document.getElementById('corr-file').value = '';
                
                // æ¸…é™¤æ–‡ä»¶åˆ—è¡¨
                document.getElementById('pdb-list').innerHTML = '';
                document.getElementById('dist-list').innerHTML = '';
                document.getElementById('corr-list').innerHTML = '';
                
                // æ¸…é™¤æ–‡ä»¶å­˜å‚¨
                uploadedFiles['pdb-file'] = null;
                uploadedFiles['dist-file'] = null;
                uploadedFiles['corr-file'] = null;
                
                // ç§»é™¤ä¸Šä¼ åŒºåŸŸçš„åé¦ˆ
                document.getElementById('pdb-upload').classList.remove('has-file');
                document.getElementById('dist-upload').classList.remove('has-file');
                document.getElementById('corr-upload').classList.remove('has-file');
                
                document.getElementById('pdb-selected').style.display = 'none';
                document.getElementById('dist-selected').style.display = 'none';
                document.getElementById('corr-selected').style.display = 'none';
                
                // é‡ç½®å‚æ•°
                document.getElementById('threshold').value = '6.0';
                document.getElementById('significance').value = '0.3';
                document.getElementById('epsilon').value = '0.000001';
                
                // éšè—ç»“æœ
                document.getElementById('results-section').style.display = 'none';
                document.getElementById('log-output').style.display = 'none';
                document.getElementById('progress-container').style.display = 'none';
                
                // æ¸…é™¤æ—¥å¿—
                document.getElementById('log-output').textContent = '';
                
                logMessage('æ‰€æœ‰è®¾ç½®å·²é‡ç½®ã€‚');
            });
            
            // æ—¥å¿—å‡½æ•°
            function logMessage(message) {
                const logOutput = document.getElementById('log-output');
                logOutput.style.display = 'block';
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                logOutput.textContent += `${timestamp}: ${message}\n`;
                logOutput.scrollTop = logOutput.scrollHeight;
            }
            
            // æ›´æ–°è¿›åº¦æ¡
            function updateProgress(percent, message) {
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                
                progressFill.style.width = `${percent}%`;
                progressText.textContent = message;
            }
            
            // çŸ©é˜µåŠ è½½å‡½æ•°
            function loadMatrix(file, callback) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const data = e.target.result;
                    let matrix;
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸º.npyæ–‡ä»¶ï¼ˆç®€å•çš„æ£€æŸ¥ï¼Œä»…é€šè¿‡æ–‡ä»¶æ‰©å±•åï¼‰
                    if (file.name.toLowerCase().endsWith('.npy')) {
                        // æ³¨æ„ï¼šæµè§ˆå™¨ä¸­æ— æ³•ç›´æ¥è§£æ.npyäºŒè¿›åˆ¶æ ¼å¼
                        // è¿™é‡Œæˆ‘ä»¬å‡è®¾.npyæ–‡ä»¶å®é™…ä¸Šæ˜¯æ–‡æœ¬æ ¼å¼ï¼Œæˆ–è€…æˆ‘ä»¬éœ€è¦å…¶ä»–æ–¹æ³•
                        // ä¸ºç®€åŒ–ï¼Œæˆ‘ä»¬å°†è¦æ±‚ç”¨æˆ·ä¸Šä¼ æ–‡æœ¬æ ¼å¼
                        callback(new Error('æµè§ˆå™¨ä¸­ä¸æ”¯æŒ.npyäºŒè¿›åˆ¶æ ¼å¼ï¼Œè¯·ä¸Šä¼ æ–‡æœ¬æ ¼å¼(.txt, .dat, .csv)'));
                        return;
                    } else {
                        // æ–‡æœ¬æ ¼å¼çŸ©é˜µ
                        try {
                            const lines = data.trim().split('\n');
                            matrix = lines.map(line => 
                                line.trim().split(/\s+|,/)
                                     .filter(val => val !== '')
                                     .map(parseFloat)
                            );
                            
                            // éªŒè¯çŸ©é˜µæ˜¯å¦ä¸ºæ–¹é˜µ
                            const n = matrix.length;
                            for (let i = 0; i < n; i++) {
                                if (matrix[i].length !== n) {
                                    callback(new Error(`çŸ©é˜µä¸æ˜¯æ–¹é˜µ: ç¬¬${i+1}è¡Œæœ‰${matrix[i].length}ä¸ªå…ƒç´ ï¼Œä½†æœŸæœ›${n}ä¸ª`));
                                    return;
                                }
                            }
                            
                            callback(null, matrix);
                        } catch (error) {
                            callback(new Error(`è§£æçŸ©é˜µæ—¶å‡ºé”™: ${error.message}`));
                        }
                    }
                };
                
                reader.onerror = function() {
                    callback(new Error('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™'));
                };
                
                reader.readAsText(file);
            }
            
            // çŸ©é˜µæ¸…ç†å‡½æ•°
            function sanitizeMatrix(M, fill = 0.0) {
                const n = M.length;
                const result = new Array(n);
                
                for (let i = 0; i < n; i++) {
                    result[i] = new Array(n);
                    for (let j = 0; j < n; j++) {
                        let val = M[i][j];
                        
                        // å¤„ç†NaNå’ŒInf
                        if (isNaN(val) || !isFinite(val)) {
                            val = fill;
                        }
                        
                        result[i][j] = val;
                    }
                }
                
                // å¯¹ç§°åŒ–
                for (let i = 0; i < n; i++) {
                    for (let j = i + 1; j < n; j++) {
                        const avg = 0.5 * (result[i][j] + result[j][i]);
                        result[i][j] = avg;
                        result[j][i] = avg;
                    }
                }
                
                // å¯¹è§’çº¿ç½®é›¶
                for (let i = 0; i < n; i++) {
                    result[i][i] = 0.0;
                }
                
                return result;
            }
            
            // æ„å»ºå›¾å‡½æ•°
            function buildGraph(dist, corr, d_thresh, eps) {
                const N = dist.length;
                const nodes = Array.from({length: N}, (_, i) => i + 1);
                
                // åˆ›å»ºå›¾æ•°æ®ç»“æ„
                const graph = {
                    nodes: nodes,
                    edges: [],
                    adjacency: new Array(N + 1).fill().map(() => [])
                };
                
                for (let i = 0; i < N; i++) {
                    for (let j = i + 1; j < N; j++) {
                        if (dist[i][j] <= d_thresh) {
                            const cij = corr[i][j];
                            const length = -Math.log(Math.max(Math.abs(cij), eps));
                            
                            graph.edges.push({
                                i: i + 1,
                                j: j + 1,
                                weight: length,
                                corr: cij,
                                dist: dist[i][j]
                            });
                            
                            graph.adjacency[i + 1].push({node: j + 1, weight: length});
                            graph.adjacency[j + 1].push({node: i + 1, weight: length});
                        }
                    }
                }
                
                return graph;
            }
            
            // Dijkstraç®—æ³•
            function dijkstra(graph, start) {
                const N = graph.nodes.length;
                const distances = new Array(N + 1).fill(Infinity);
                const visited = new Array(N + 1).fill(false);
                const previous = new Array(N + 1).fill(null);
                
                distances[start] = 0;
                
                for (let count = 0; count < N; count++) {
                    // æ‰¾åˆ°æœªè®¿é—®èŠ‚ç‚¹ä¸­è·ç¦»æœ€å°çš„èŠ‚ç‚¹
                    let minDist = Infinity;
                    let u = -1;
                    
                    for (let i = 1; i <= N; i++) {
                        if (!visited[i] && distances[i] < minDist) {
                            minDist = distances[i];
                            u = i;
                        }
                    }
                    
                    if (u === -1) break;
                    
                    visited[u] = true;
                    
                    // æ›´æ–°é‚»å±…èŠ‚ç‚¹çš„è·ç¦»
                    for (const neighbor of graph.adjacency[u]) {
                        const v = neighbor.node;
                        const weight = neighbor.weight;
                        
                        if (!visited[v]) {
                            const alt = distances[u] + weight;
                            if (alt < distances[v]) {
                                distances[v] = alt;
                                previous[v] = u;
                            }
                        }
                    }
                }
                
                // é‡å»ºè·¯å¾„
                const paths = {};
                for (let v = 1; v <= N; v++) {
                    if (distances[v] < Infinity && v !== start) {
                        const path = [];
                        let current = v;
                        
                        while (current !== null) {
                            path.unshift(current);
                            current = previous[current];
                        }
                        
                        paths[v] = path;
                    }
                }
                
                return paths;
            }
            
            // æ‰€æœ‰èŠ‚ç‚¹å¯¹çš„æœ€çŸ­è·¯å¾„ä½¿ç”¨ç»Ÿè®¡
            function allPairsUsage(graph) {
                const edgeCount = new Map();
                
                // åˆå§‹åŒ–è¾¹è®¡æ•°
                for (const edge of graph.edges) {
                    const key = [Math.min(edge.i, edge.j), Math.max(edge.i, edge.j)].join(',');
                    edgeCount.set(key, 0);
                }
                
                // å¯¹æ¯ä¸ªèŠ‚ç‚¹è¿è¡ŒDijkstra
                const nodes = graph.nodes;
                for (let idx = 0; idx < nodes.length; idx++) {
                    const u = nodes[idx];
                    const paths = dijkstra(graph, u);
                    
                    for (const v in paths) {
                        const path = paths[v];
                        if (parseInt(v) <= u || path.length < 2) continue;
                        
                        // ç»Ÿè®¡è·¯å¾„ä¸Šçš„æ¯æ¡è¾¹
                        for (let i = 0; i < path.length - 1; i++) {
                            const a = path[i];
                            const b = path[i + 1];
                            const key = [Math.min(a, b), Math.max(a, b)].join(',');
                            
                            if (edgeCount.has(key)) {
                                edgeCount.set(key, edgeCount.get(key) + 1);
                            }
                        }
                    }
                }
                
                // å½’ä¸€åŒ–
                let maxCount = 0;
                for (const count of edgeCount.values()) {
                    if (count > maxCount) maxCount = count;
                }
                
                const usageNorm = {};
                for (const [key, count] of edgeCount.entries()) {
                    usageNorm[key] = maxCount > 0 ? count / maxCount : 0;
                }
                
                return usageNorm;
            }
            
            // ç”Ÿæˆç»“æœæ–‡ä»¶
            function generateResults(outdir, usageNorm, sig_thresh, graph, pdbName) {
                // ç­›é€‰è¾¹
                const edges = [];
                for (const [key, score] of Object.entries(usageNorm)) {
                    if (score >= sig_thresh) {
                        const [i, j] = key.split(',').map(Number);
                        const corr = graph.edges.find(e => 
                            (e.i === i && e.j === j) || (e.i === j && e.j === i)
                        )?.corr || 0;
                        edges.push({i, j, score, corr});
                    }
                }
                
                // æŒ‰åˆ†æ•°é™åºæ’åº
                edges.sort((a, b) => b.score - a.score);
                
                // è®¡ç®—èŠ‚ç‚¹åˆ†æ•°
                const nodeScores = {};
                graph.nodes.forEach(node => nodeScores[node] = 0);
                
                for (const edge of edges) {
                    nodeScores[edge.i] += edge.score;
                    nodeScores[edge.j] += edge.score;
                }
                
                // æ’åºèŠ‚ç‚¹
                const rankedNodes = Object.entries(nodeScores)
                    .sort((a, b) => b[1] - a[1])
                    .map(([node, score], index) => ({node: parseInt(node), score, rank: index + 1}));
                
                return { edges, nodeScores, rankedNodes };
            }
            
            // ç”ŸæˆTSVå†…å®¹
            function generateTSVFiles(results) {
                // è¾¹æ–‡ä»¶
                let edgesTSV = "i\tj\tscore\tcorr\n";
                for (const edge of results.edges) {
                    edgesTSV += `${edge.i}\t${edge.j}\t${edge.score.toFixed(6)}\t${edge.corr.toFixed(6)}\n`;
                }
                
                // èŠ‚ç‚¹æ–‡ä»¶
                let nodesTSV = "residue\tscore\trank\n";
                for (const node of results.rankedNodes) {
                    nodesTSV += `${node.node}\t${node.score.toFixed(6)}\t${node.rank}\n`;
                }
                
                return { edgesTSV, nodesTSV };
            }
            
            // ç”ŸæˆPyMOLè„šæœ¬
            function generatePyMOLScript(pdbName, edges, nodeScores, pdbFileName) {
                // æå–èŠ‚ç‚¹åˆ†æ•°å’Œè¾¹åˆ†æ•°ç”¨äºç¼©æ”¾
                const nodeValues = Object.values(nodeScores);
                const nodeMin = Math.min(...nodeValues);
                const nodeMax = Math.max(...nodeValues);
                const nodeRange = nodeMax - nodeMin || 1; // é¿å…é™¤ä»¥é›¶
                
                const edgeValues = edges.map(e => e.score);
                const edgeMin = Math.min(...edgeValues);
                const edgeMax = Math.max(...edgeValues);
                const edgeRange = edgeMax - edgeMin || 1;
                
                // ç¼©æ”¾å‡½æ•°
                const scaleNode = (score) => 0.4 + 0.7 * (score - nodeMin) / nodeRange;
                const scaleEdge = (score) => 0.4 + 0.7 * (score - edgeMin) / edgeRange;
                
                let pml = `# PyMOL script for SPM visualization
# Generated by SPM Web Tool
# PDB: ${pdbFileName}

# Load structure
load ${pdbFileName}

# Set display
show cartoon
set cartoon_transparency, 0.5
bg_color white

# SPM edges and nodes\n`;

                // ä¸ºæ¯æ¡è¾¹åˆ›å»ºå¯¹è±¡
                edges.forEach((edge, idx) => {
                    const objName = `SPM_${pdbName}_${idx + 1}`;
                    const color = edge.corr >= 0 ? "blue" : "red";
                    
                    pml += `
# Edge ${edge.i}-${edge.j} (score: ${edge.score.toFixed(4)}, corr: ${edge.corr.toFixed(4)})
create ${objName}, name ca and resi ${edge.i}+${edge.j}
show spheres, ${objName}
set sphere_scale, ${scaleNode(nodeScores[edge.i]).toFixed(4)}, ${objName} and resi ${edge.i}
set sphere_scale, ${scaleNode(nodeScores[edge.j]).toFixed(4)}, ${objName} and resi ${edge.j}
bond name ca and resi ${edge.i}, name ca and resi ${edge.j}
set stick_radius, ${scaleEdge(edge.score).toFixed(4)}, ${objName}
show sticks, ${objName}
color ${color}, ${objName}\n`;
                });

                // åˆ›å»ºç»„
                const edgeObjs = edges.map((_, idx) => `SPM_${pdbName}_${idx + 1}`).join(' ');
                pml += `
# Group all SPM objects
group SPM_${pdbName}, ${edgeObjs}

# Center and zoom
center all
zoom all

# Additional settings
set stick_color, gray40, SPM_${pdbName}
set sphere_color, gray40, SPM_${pdbName}

print "SPM visualization loaded for ${pdbFileName}"
print "${edges.length} significant edges displayed"
print "Blue: positive correlation, Red: negative correlation"`;

                return pml;
            }
            
            // ä¸»è®¡ç®—å‡½æ•°
            async function runSPMCalculation() {
                // è·å–æ–‡ä»¶
                const pdbFile = uploadedFiles['pdb-file'];
                const distFile = uploadedFiles['dist-file'];
                const corrFile = uploadedFiles['corr-file'];
                
                // è·å–å‚æ•°
                const threshold = parseFloat(document.getElementById('threshold').value);
                const significance = parseFloat(document.getElementById('significance').value);
                const epsilon = parseFloat(document.getElementById('epsilon').value);
                
                // éªŒè¯è¾“å…¥
                if (!pdbFile || !distFile || !corrFile) {
                    alert('è¯·ä¸Šä¼ æ‰€æœ‰å¿…éœ€æ–‡ä»¶ï¼šPDBæ–‡ä»¶ã€è·ç¦»çŸ©é˜µå’Œç›¸å…³çŸ©é˜µ');
                    return;
                }
                
                // æ˜¾ç¤ºè¿›åº¦æ¡
                document.getElementById('progress-container').style.display = 'block';
                document.getElementById('log-output').style.display = 'block';
                document.getElementById('calculate-btn').disabled = true;
                
                logMessage('å¼€å§‹SPMè®¡ç®—...');
                logMessage(`å‚æ•°è®¾ç½®: è·ç¦»é˜ˆå€¼=${threshold}Ã…, æ˜¾è‘—æ€§é˜ˆå€¼=${significance}, Îµ=${epsilon}`);
                updateProgress(5, 'æ­£åœ¨åŠ è½½æ–‡ä»¶...');
                
                try {
                    // åŠ è½½è·ç¦»çŸ©é˜µ
                    logMessage('æ­£åœ¨åŠ è½½è·ç¦»çŸ©é˜µ...');
                    const distMatrix = await new Promise((resolve, reject) => {
                        loadMatrix(distFile, (err, matrix) => {
                            if (err) reject(err);
                            else resolve(matrix);
                        });
                    });
                    
                    updateProgress(20, 'æ­£åœ¨åŠ è½½ç›¸å…³çŸ©é˜µ...');
                    logMessage(`è·ç¦»çŸ©é˜µåŠ è½½å®Œæˆ: ${distMatrix.length}Ã—${distMatrix.length}`);
                    
                    // åŠ è½½ç›¸å…³çŸ©é˜µ
                    logMessage('æ­£åœ¨åŠ è½½ç›¸å…³çŸ©é˜µ...');
                    const corrMatrix = await new Promise((resolve, reject) => {
                        loadMatrix(corrFile, (err, matrix) => {
                            if (err) reject(err);
                            else resolve(matrix);
                        });
                    });
                    
                    updateProgress(35, 'æ­£åœ¨éªŒè¯çŸ©é˜µ...');
                    logMessage(`ç›¸å…³çŸ©é˜µåŠ è½½å®Œæˆ: ${corrMatrix.length}Ã—${corrMatrix.length}`);
                    
                    // éªŒè¯çŸ©é˜µå¤§å°
                    if (distMatrix.length !== corrMatrix.length) {
                        throw new Error(`çŸ©é˜µå¤§å°ä¸åŒ¹é…: è·ç¦»çŸ©é˜µ${distMatrix.length}Ã—${distMatrix.length}, ç›¸å…³çŸ©é˜µ${corrMatrix.length}Ã—${corrMatrix.length}`);
                    }
                    
                    const N = distMatrix.length;
                    logMessage(`ç³»ç»Ÿå¤§å°: ${N}ä¸ªæ®‹åŸº`);
                    
                    // æ¸…ç†çŸ©é˜µ
                    updateProgress(40, 'æ­£åœ¨æ¸…ç†çŸ©é˜µ...');
                    logMessage('æ­£åœ¨æ¸…ç†çŸ©é˜µ...');
                    const distClean = sanitizeMatrix(distMatrix);
                    const corrClean = sanitizeMatrix(corrMatrix);
                    
                    // æ„å»ºå›¾
                    updateProgress(50, 'æ­£åœ¨æ„å»ºå›¾...');
                    logMessage(`ä½¿ç”¨è·ç¦»é˜ˆå€¼ ${threshold}Ã… æ„å»ºå›¾...`);
                    const graph = buildGraph(distClean, corrClean, threshold, epsilon);
                    logMessage(`å›¾æ„å»ºå®Œæˆ: ${graph.nodes.length}ä¸ªèŠ‚ç‚¹, ${graph.edges.length}æ¡è¾¹`);
                    
                    // è®¡ç®—æœ€çŸ­è·¯å¾„ä½¿ç”¨æƒ…å†µ
                    updateProgress(60, 'æ­£åœ¨è®¡ç®—æœ€çŸ­è·¯å¾„...');
                    logMessage('æ­£åœ¨è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹å¯¹ä¹‹é—´çš„æœ€çŸ­è·¯å¾„...');
                    const usageNorm = allPairsUsage(graph);
                    logMessage(`è·¯å¾„è®¡ç®—å®Œæˆï¼Œç»Ÿè®¡äº†${Object.keys(usageNorm).length}æ¡è¾¹çš„ä½¿ç”¨æƒ…å†µ`);
                    
                    // ç”Ÿæˆç»“æœ
                    updateProgress(80, 'æ­£åœ¨ç”Ÿæˆç»“æœ...');
                    logMessage(`ä½¿ç”¨æ˜¾è‘—æ€§é˜ˆå€¼ ${significance} ç­›é€‰è¾¹...`);
                    
                    const pdbName = pdbFile.name.replace(/\.[^/.]+$/, ""); // ç§»é™¤æ‰©å±•å
                    const results = generateResults("spm_out", usageNorm, significance, graph, pdbName);
                    
                    logMessage(`ç­›é€‰ç»“æœ: ${results.edges.length}æ¡æ˜¾è‘—è¾¹`);
                    
                    // ç”Ÿæˆæ–‡ä»¶å†…å®¹
                    const tsvFiles = generateTSVFiles(results);
                    const pmlScript = generatePyMOLScript(pdbName, results.edges, results.nodeScores, pdbFile.name);
                    
                    updateProgress(95, 'æ­£åœ¨æ‰“åŒ…ç»“æœ...');
                    
                    // åˆ›å»ºZIPæ–‡ä»¶
                    const zip = new JSZip();
                    const folder = zip.folder("spm_out");
                    
                    folder.file("spm_edges.tsv", tsvFiles.edgesTSV);
                    folder.file("spm_nodes.tsv", tsvFiles.nodesTSV);
                    folder.file("spm.pml", pmlScript);
                    
                    // ç”ŸæˆZIP
                    const zipBlob = await zip.generateAsync({type: "blob"});
                    
                    updateProgress(100, 'è®¡ç®—å®Œæˆï¼');
                    logMessage('SPMè®¡ç®—æˆåŠŸå®Œæˆï¼');
                    
                    // æ˜¾ç¤ºç»“æœ
                    displayResults(zipBlob, results, pmlScript, pdbName);
                    
                } catch (error) {
                    logMessage(`é”™è¯¯: ${error.message}`);
                    updateProgress(0, 'è®¡ç®—å¤±è´¥');
                    alert(`è®¡ç®—è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`);
                } finally {
                    document.getElementById('calculate-btn').disabled = false;
                }
            }
            
            // æ˜¾ç¤ºç»“æœå‡½æ•°
            function displayResults(zipBlob, results, pmlScript, pdbName) {
                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                document.getElementById('results-section').style.display = 'block';
                
                // ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
                const resultFiles = document.getElementById('result-files');
                resultFiles.innerHTML = '';
                
                const files = [
                    { name: 'spm_edges.tsv', description: 'è¾¹åˆ—è¡¨ (TSVæ ¼å¼)' },
                    { name: 'spm_nodes.tsv', description: 'èŠ‚ç‚¹åˆ†æ•° (TSVæ ¼å¼)' },
                    { name: 'spm.pml', description: 'PyMOLå¯è§†åŒ–è„šæœ¬' }
                ];
                
                files.forEach(file => {
                    const card = document.createElement('div');
                    card.className = 'file-card';
                    
                    const fileInfo = document.createElement('div');
                    fileInfo.innerHTML = `<strong>${file.name}</strong><br><small>${file.description}</small>`;
                    
                    card.appendChild(fileInfo);
                    resultFiles.appendChild(card);
                });
                
                // ä¿å­˜ZIP blobä¾›ä¸‹è½½ä½¿ç”¨
                window.resultZipBlob = zipBlob;
                window.resultPMLScript = pmlScript;
                
                logMessage('ç»“æœå·²ç”Ÿæˆï¼Œå¯ä»¥ä¸‹è½½ã€‚');
            }
            
            // ä¸‹è½½æ‰€æœ‰æ–‡ä»¶(ZIP)
            document.getElementById('download-all-btn').addEventListener('click', function() {
                if (window.resultZipBlob) {
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    saveAs(window.resultZipBlob, `spm_results_${timestamp}.zip`);
                    logMessage('ZIPæ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ã€‚');
                } else {
                    alert('æ²¡æœ‰å¯ä¸‹è½½çš„ç»“æœæ–‡ä»¶ã€‚è¯·å…ˆè¿›è¡Œè®¡ç®—ã€‚');
                }
            });
            
            // å¼€å§‹è®¡ç®—æŒ‰é’®
            document.getElementById('calculate-btn').addEventListener('click', runSPMCalculation);
            
            // åˆå§‹æ—¥å¿—æ¶ˆæ¯
            logMessage('SPM Webå·¥å…·å·²å°±ç»ªã€‚è¯·ä¸Šä¼ æ–‡ä»¶å¹¶è®¾ç½®å‚æ•°ã€‚');
        });
    </script>
</body>
</html>
