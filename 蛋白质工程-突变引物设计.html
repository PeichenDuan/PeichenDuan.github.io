<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大肠杆菌表达系统的酶突变引物设计</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .tool-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            width: 100%;
            text-align: center;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            margin-top: 15px;
            text-decoration: none;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .section {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
        }

        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
        }

        .param-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .param-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .param-label {
            flex: 0 0 150px;
            font-weight: 600;
            color: #555;
        }

        .param-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .param-input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .param-separator {
            margin: 0 5px;
            font-weight: 600;
        }

        .mutation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: var(--border-radius);
        }

        .mutation-input {
            flex: 1;
        }

        .remove-mutation {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .remove-mutation:hover {
            background-color: #c0392b;
        }

        .add-mutation {
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            margin-top: 10px;
        }

        .add-mutation:hover {
            background-color: #219653;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }

        .design-button, .download-button {
            padding: 12px 30px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 16px;
        }

        .design-button {
            background-color: var(--secondary-color);
            color: white;
        }

        .design-button:hover {
            background-color: #2980b9;
        }

        .download-button {
            background-color: var(--success-color);
            color: white;
        }

        .download-button:hover {
            background-color: #219653;
        }

        .download-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .result-box {
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            margin-top: 20px;
            border-left: 4px solid var(--secondary-color);
            display: none;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .result-table th, .result-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .result-table th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 600;
        }

        .result-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .result-table tr:hover {
            background-color: #e9f7fe;
        }

        .primer-sequence {
            font-family: monospace;
            background: #f1f8ff;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #d1e7ff;
            font-size: 0.9em;
        }

        .primer-param {
            font-size: 0.85rem;
            color: #666;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-box {
            background-color: #ffe6e6;
            border-left: 4px solid var(--accent-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            color: #d32f2f;
            display: none;
        }

        .success-message {
            background-color: #d4edda;
            border-left: 4px solid var(--success-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            color: #155724;
            display: none;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .param-group {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .result-table {
                font-size: 0.8rem;
            }
            
            .result-table th, .result-table td {
                padding: 8px 6px;
            }
            
            .param-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .param-label {
                margin-bottom: 5px;
                flex: 0 0 auto;
            }
            
            .param-inputs {
                width: 100%;
            }
            
            .param-input {
                width: 100%;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="tool-header">
        <h1 style="color: white;">大肠杆菌表达系统的酶突变引物设计</h1>
        <a href="index.html" class="back-button">返回主界面</a>
    </div>
    
    <div class="content">
        <div class="section">
            <h2>DNA序列输入</h2>
            <div class="form-group">
                <label for="dna-sequence">DNA序列:</label>
                <textarea id="dna-sequence" placeholder="输入DNA序列（可以含有数字和空格，ATCG不区分大小写）"></textarea>
            </div>
        </div>
        
        <div class="section">
            <h2>突变位点设置</h2>
            <div id="mutations-container">
                <div class="mutation-item">
                    <input type="text" class="mutation-input" placeholder="例如：A21S" data-index="0">
                    <button class="remove-mutation" onclick="removeMutation(0)">删除</button>
                </div>
            </div>
            <button class="add-mutation" onclick="addMutation()">添加突变体</button>
        </div>
        
        <div class="section">
            <h2>引物设计参数</h2>
            <div class="param-group">
                <div>
                    <h3>熔点 (°C)</h3>
                    <div class="param-row">
                        <span class="param-label">最小值:</span>
                        <div class="param-inputs">
                            <input type="number" id="tm-min" class="param-input" value="60" min="40" max="90">
                            <span class="param-separator">-</span>
                            <input type="number" id="tm-max" class="param-input" value="75" min="40" max="90">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3>GC含量 (%)</h3>
                    <div class="param-row">
                        <span class="param-label">最小值:</span>
                        <div class="param-inputs">
                            <input type="number" id="gc-min" class="param-input" value="30" min="0" max="100">
                            <span class="param-separator">-</span>
                            <input type="number" id="gc-max" class="param-input" value="70" min="0" max="100">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3>引物长度 (bp)</h3>
                    <div class="param-row">
                        <span class="param-label">最小值:</span>
                        <div class="param-inputs">
                            <input type="number" id="length-min" class="param-input" value="25" min="15" max="60">
                            <span class="param-separator">-</span>
                            <input type="number" id="length-max" class="param-input" value="35" min="15" max="60">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3>5'端碱基数 (BP)</h3>
                    <div class="param-row">
                        <span class="param-label">最小值:</span>
                        <div class="param-inputs">
                            <input type="number" id="five-min" class="param-input" value="0" min="0" max="50">
                            <span class="param-separator">-</span>
                            <input type="number" id="five-max" class="param-input" value="30" min="0" max="50">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3>3'端碱基数 (BP)</h3>
                    <div class="param-row">
                        <span class="param-label">最小值:</span>
                        <div class="param-inputs">
                            <input type="number" id="three-min" class="param-input" value="5" min="0" max="30">
                            <span class="param-separator">-</span>
                            <input type="number" id="three-max" class="param-input" value="15" min="0" max="30">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="error-box" class="error-box"></div>
        <div id="success-box" class="success-message"></div>
        
        <div class="section">
            <h2>引物设计结果</h2>
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>正在设计引物...</p>
            </div>
            <div id="result-box" class="result-box">
                <div id="result-content"></div>
            </div>
            
            <div class="button-group">
                <button class="design-button" onclick="designPrimers()">设计引物</button>
                <button class="download-button" id="download-btn" disabled onclick="downloadResults()">下载结果 (XLSX)</button>
            </div>
        </div>
    </div>
    
    <div style="padding: 15px; background-color: var(--primary-color); color: white; text-align: center; margin-top: 30px;">
        江南大学 粮食发酵工艺与技术国家工程实验室
    </div>

    <script>
        let mutationCount = 1;
        let primerResults = [];
        
        // 大肠杆菌最优密码子表（唯一密码子）
        const optimalCodons = {
            'F': 'TTT', 'Y': 'TAT', 'C': 'TGC', 'W': 'TGG',
            'H': 'CAT', 'P': 'CCG', 'Q': 'CAG', 'L': 'CTG',
            'R': 'CGC', 'I': 'ATT', 'M': 'ATG', 'T': 'ACC',
            'N': 'AAC', 'K': 'AAA', 'S': 'AGC', 'G': 'GGC',
            'D': 'GAT', 'E': 'GAA', 'A': 'GCG', 'V': 'GTG',
            '*': 'TAA'
        };
        
        // 氨基酸单字母到三字母映射
        const aaMapping = {
            'A': 'Ala', 'R': 'Arg', 'N': 'Asn', 'D': 'Asp',
            'C': 'Cys', 'E': 'Glu', 'Q': 'Gln', 'G': 'Gly',
            'H': 'His', 'I': 'Ile', 'L': 'Leu', 'K': 'Lys',
            'M': 'Met', 'F': 'Phe', 'P': 'Pro', 'S': 'Ser',
            'T': 'Thr', 'W': 'Trp', 'Y': 'Tyr', 'V': 'Val'
        };
        
        // 标准遗传密码子表（用于验证原始氨基酸）
        const geneticCode = {
            'TTT': 'F', 'TTC': 'F', 'TTA': 'L', 'TTG': 'L',
            'CTT': 'L', 'CTC': 'L', 'CTA': 'L', 'CTG': 'L',
            'ATT': 'I', 'ATC': 'I', 'ATA': 'I', 'ATG': 'M',
            'GTT': 'V', 'GTC': 'V', 'GTA': 'V', 'GTG': 'V',
            'TCT': 'S', 'TCC': 'S', 'TCA': 'S', 'TCG': 'S',
            'CCT': 'P', 'CCC': 'P', 'CCA': 'P', 'CCG': 'P',
            'ACT': 'T', 'ACC': 'T', 'ACA': 'T', 'ACG': 'T',
            'GCT': 'A', 'GCC': 'A', 'GCA': 'A', 'GCG': 'A',
            'TAT': 'Y', 'TAC': 'Y', 'TAA': '*', 'TAG': '*',
            'CAT': 'H', 'CAC': 'H', 'CAA': 'Q', 'CAG': 'Q',
            'AAT': 'N', 'AAC': 'N', 'AAA': 'K', 'AAG': 'K',
            'GAT': 'D', 'GAC': 'D', 'GAA': 'E', 'GAG': 'E',
            'TGT': 'C', 'TGC': 'C', 'TGA': '*', 'TGG': 'W',
            'CGT': 'R', 'CGC': 'R', 'CGA': 'R', 'CGG': 'R',
            'AGT': 'S', 'AGC': 'S', 'AGA': 'R', 'AGG': 'R',
            'GGT': 'G', 'GGC': 'G', 'GGA': 'G', 'GGG': 'G'
        };
        
        // 清理DNA序列
        function cleanDNASequence(seq) {
            return seq.toUpperCase().replace(/[^ATCG]/g, '');
        }
        
        // 计算GC含量百分比
        function calculateGC(seq) {
            const gcCount = (seq.match(/[GC]/g) || []).length;
            return (gcCount / seq.length) * 100;
        }
        
        // 计算不匹配碱基数
        function calculateMismatch(originalCodon, newCodon) {
            let mismatch = 0;
            for (let i = 0; i < 3; i++) {
                if (originalCodon[i] !== newCodon[i]) {
                    mismatch++;
                }
            }
            return mismatch;
        }
        
        // 计算熔点 - 修正后的公式
        function calculateTm(seq, gcPercent, mismatch) {
            const N = seq.length;
            const gcContent = gcPercent / 100; // 转换为小数
            const mismatchPercent = mismatch / N; // 不匹配百分比
            return 81.5 + 0.41 * gcPercent - 675 / N - mismatchPercent * 100;
        }
        
        // 添加突变输入框
        function addMutation() {
            const container = document.getElementById('mutations-container');
            const newItem = document.createElement('div');
            newItem.className = 'mutation-item';
            newItem.innerHTML = `
                <input type="text" class="mutation-input" placeholder="例如：A21S" data-index="${mutationCount}">
                <button class="remove-mutation" onclick="removeMutation(${mutationCount})">删除</button>
            `;
            container.appendChild(newItem);
            mutationCount++;
        }
        
        // 删除突变输入框
        function removeMutation(index) {
            const inputs = document.querySelectorAll('.mutation-input');
            if (inputs.length > 1) {
                const container = document.getElementById('mutations-container');
                const items = container.querySelectorAll('.mutation-item');
                items.forEach((item, i) => {
                    const input = item.querySelector('.mutation-input');
                    if (parseInt(input.dataset.index) === index) {
                        container.removeChild(item);
                    }
                });
            }
        }
        
        // 显示错误信息
        function showError(message) {
            const errorBox = document.getElementById('error-box');
            errorBox.innerHTML = `<p><strong>错误:</strong> ${message}</p>`;
            errorBox.style.display = 'block';
            document.getElementById('success-box').style.display = 'none';
        }
        
        // 显示成功信息
        function showSuccess(message) {
            const successBox = document.getElementById('success-box');
            successBox.innerHTML = `<p><strong>成功:</strong> ${message}</p>`;
            successBox.style.display = 'block';
            document.getElementById('error-box').style.display = 'none';
        }
        
        // 隐藏所有消息
        function hideMessages() {
            document.getElementById('error-box').style.display = 'none';
            document.getElementById('success-box').style.display = 'none';
        }
        
        // 验证突变格式并检查原始氨基酸
        function validateMutation(mutationStr, dnaSeq) {
            const cleanStr = mutationStr.trim();
            const match = cleanStr.match(/^([A-Z])(\d+)([A-Z])$/i);
            
            if (!match) {
                return { error: `突变格式错误: "${cleanStr}"。请使用格式如"A21S"` };
            }
            
            const [, originalAA, posStr, targetAA] = match;
            const position = parseInt(posStr);
            const original = originalAA.toUpperCase();
            const target = targetAA.toUpperCase();
            
            // 检查氨基酸代码
            if (!aaMapping[original]) {
                return { error: `无效的原始氨基酸代码: "${original}"` };
            }
            if (!aaMapping[target]) {
                return { error: `无效的目标氨基酸代码: "${target}"` };
            }
            
            // 检查位置
            if (position < 1) {
                return { error: `氨基酸位置必须为正整数: ${position}` };
            }
            
            // 计算DNA位置
            const dnaPos = (position - 1) * 3;
            
            // 检查序列边界
            if (dnaPos + 3 > dnaSeq.length) {
                return { error: `突变位置${position}超出序列范围。序列共编码${Math.floor(dnaSeq.length/3)}个氨基酸` };
            }
            
            // 获取原始密码子
            const originalCodon = dnaSeq.substring(dnaPos, dnaPos + 3);
            
            // 验证原始密码子是否有效
            if (!geneticCode[originalCodon]) {
                return { error: `位置${position}的密码子"${originalCodon}"无效` };
            }
            
            // 获取原始密码子对应的氨基酸
            const actualAA = geneticCode[originalCodon];
            
            // 检查原始氨基酸是否匹配
            if (actualAA !== original) {
                return { error: `您提供的基因第${position}位氨基酸不是${original}，而是${actualAA}，请检查基因序列或更改要求` };
            }
            
            return {
                original: original,
                position: position,
                target: target,
                dnaPos: dnaPos,
                originalCodon: originalCodon,
                actualAA: actualAA,
                success: true
            };
        }
        
        // 设计引物对 - 优化为优先选择最短序列，并优先选择末端为C或G的引物
        function designPrimerPair(dnaSeq, mutation, params) {
            const { dnaPos, target, originalCodon } = mutation;
            const optimalCodon = optimalCodons[target];
            
            if (!optimalCodon) {
                return { error: `无法找到目标氨基酸${target}的最优密码子` };
            }
            
            // 计算不匹配碱基数
            const mismatch = calculateMismatch(originalCodon, optimalCodon);
            
            // 按长度从小到大搜索
            for (let primerLength = params.lengthMin; primerLength <= params.lengthMax; primerLength++) {
                let bestPrimer = null;
                let bestPrimerScore = -Infinity;
                
                // 遍历可能的5'和3'端长度组合
                for (let fiveLen = params.fiveMin; fiveLen <= params.fiveMax; fiveLen++) {
                    for (let threeLen = params.threeMin; threeLen <= params.threeMax; threeLen++) {
                        // 检查长度是否匹配
                        if (fiveLen + 3 + threeLen !== primerLength) {
                            continue;
                        }
                        
                        // 计算起始和结束位置
                        const forwardStart = Math.max(0, dnaPos - fiveLen);
                        const forwardEnd = Math.min(dnaSeq.length, dnaPos + 3 + threeLen);
                        
                        // 检查边界
                        if (forwardStart < 0 || forwardEnd > dnaSeq.length) {
                            continue;
                        }
                        
                        // 构建上游引物
                        let forwardPrimer = dnaSeq.substring(forwardStart, dnaPos); // 5'端
                        forwardPrimer += optimalCodon; // 突变密码子
                        forwardPrimer += dnaSeq.substring(dnaPos + 3, forwardEnd); // 3'端
                        
                        // 确保长度正确
                        if (forwardPrimer.length !== primerLength) {
                            continue;
                        }
                        
                        // 构建下游引物模板（反向互补）
                        const reverseStart = Math.max(0, dnaPos - threeLen);
                        const reverseEnd = Math.min(dnaSeq.length, dnaPos + 3 + fiveLen);
                        
                        if (reverseStart < 0 || reverseEnd > dnaSeq.length) {
                            continue;
                        }
                        
                        let reverseTemplate = dnaSeq.substring(reverseStart, dnaPos); // 5'端（模板）
                        reverseTemplate += optimalCodon; // 突变密码子
                        reverseTemplate += dnaSeq.substring(dnaPos + 3, reverseEnd); // 3'端（模板）
                        
                        // 确保模板长度与引物长度相同
                        if (reverseTemplate.length !== primerLength) {
                            continue;
                        }
                        
                        // 生成下游引物（反向互补）
                        const reversePrimer = getReverseComplement(reverseTemplate);
                        
                        // 计算参数
                        const forwardGC = calculateGC(forwardPrimer);
                        const reverseGC = calculateGC(reversePrimer);
                        const forwardTm = calculateTm(forwardPrimer, forwardGC, mismatch);
                        const reverseTm = calculateTm(reversePrimer, reverseGC, mismatch);
                        
                        // 检查参数是否符合要求
                        const tmValid = forwardTm >= params.tmMin && forwardTm <= params.tmMax &&
                                      reverseTm >= params.tmMin && reverseTm <= params.tmMax;
                        const gcValid = forwardGC >= params.gcMin && forwardGC <= params.gcMax &&
                                      reverseGC >= params.gcMin && reverseGC <= params.gcMax;
                        
                        if (tmValid && gcValid) {
                            // 计算引物评分：优先选择末端为C或G的引物
                            let score = 0;
                            
                            // 上游引物末端为C或G加分
                            if (/[CG]$/.test(forwardPrimer)) {
                                score += 10;
                            }
                            
                            // 下游引物末端为C或G加分
                            if (/[CG]$/.test(reversePrimer)) {
                                score += 10;
                            }
                            
                            // Tm值接近中间值加分
                            const idealTm = (params.tmMin + params.tmMax) / 2;
                            score -= Math.abs(forwardTm - idealTm) * 0.1;
                            score -= Math.abs(reverseTm - idealTm) * 0.1;
                            
                            // GC含量接近中间值加分
                            const idealGC = (params.gcMin + params.gcMax) / 2;
                            score -= Math.abs(forwardGC - idealGC) * 0.05;
                            score -= Math.abs(reverseGC - idealGC) * 0.05;
                            
                            // 如果这是当前长度下评分最高的引物，记录它
                            if (score > bestPrimerScore) {
                                bestPrimerScore = score;
                                bestPrimer = {
                                    forward: forwardPrimer,
                                    reverse: reversePrimer,
                                    forwardTm: forwardTm,
                                    forwardGc: forwardGC,
                                    reverseTm: reverseTm,
                                    reverseGc: reverseGC,
                                    length: primerLength,
                                    fiveLen: fiveLen,
                                    threeLen: threeLen,
                                    mismatch: mismatch,
                                    score: score
                                };
                            }
                        }
                    }
                }
                
                // 如果找到当前长度的最佳引物，返回它
                if (bestPrimer) {
                    return {
                        success: true,
                        primer: bestPrimer
                    };
                }
            }
            
            return { error: '无法设计符合所有条件的引物' };
        }
        
        // 获取反向互补序列
        function getReverseComplement(seq) {
            const complement = { 'A': 'T', 'T': 'A', 'C': 'G', 'G': 'C' };
            let result = '';
            for (let i = seq.length - 1; i >= 0; i--) {
                result += complement[seq[i]] || seq[i];
            }
            return result;
        }
        
        // 设计引物
        function designPrimers() {
            hideMessages();
            
            // 获取DNA序列
            const dnaSeq = cleanDNASequence(document.getElementById('dna-sequence').value);
            if (!dnaSeq) {
                showError('请输入DNA序列');
                return;
            }
            
            if (dnaSeq.length < 30) {
                showError('DNA序列太短');
                return;
            }
            
            // 获取突变信息
            const mutationInputs = document.querySelectorAll('.mutation-input');
            const mutations = [];
            
            for (const input of mutationInputs) {
                const value = input.value.trim();
                if (value) {
                    const mutation = validateMutation(value, dnaSeq);
                    if (mutation.error) {
                        showError(mutation.error);
                        return;
                    }
                    if (mutation.success) {
                        mutations.push(mutation);
                    }
                }
            }
            
            if (mutations.length === 0) {
                showError('请输入至少一个突变位点');
                return;
            }
            
            // 获取参数
            const params = {
                tmMin: parseFloat(document.getElementById('tm-min').value),
                tmMax: parseFloat(document.getElementById('tm-max').value),
                gcMin: parseFloat(document.getElementById('gc-min').value),
                gcMax: parseFloat(document.getElementById('gc-max').value),
                lengthMin: parseInt(document.getElementById('length-min').value),
                lengthMax: parseInt(document.getElementById('length-max').value),
                fiveMin: parseInt(document.getElementById('five-min').value),
                fiveMax: parseInt(document.getElementById('five-max').value),
                threeMin: parseInt(document.getElementById('three-min').value),
                threeMax: parseInt(document.getElementById('three-max').value)
            };
            
            // 验证参数
            if (params.tmMin > params.tmMax || params.gcMin > params.gcMax || 
                params.lengthMin > params.lengthMax || params.fiveMin > params.fiveMax || 
                params.threeMin > params.threeMax) {
                showError('最小值不能大于最大值');
                return;
            }
            
            // 显示加载动画
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result-box').style.display = 'none';
            
            // 设计引物
            setTimeout(() => {
                generatePrimers(dnaSeq, mutations, params);
            }, 500);
        }
        
        // 生成引物
        function generatePrimers(dnaSeq, mutations, params) {
            primerResults = [];
            let successCount = 0;
            
            for (let i = 0; i < mutations.length; i++) {
                const mutation = mutations[i];
                const mutationName = `${mutation.original}${mutation.position}${mutation.target}`;
                
                const result = designPrimerPair(dnaSeq, mutation, params);
                
                if (result.error) {
                    primerResults.push({
                        name: mutationName,
                        error: result.error
                    });
                } else {
                    const primer = result.primer;
                    primerResults.push({
                        name: mutationName,
                        forward: primer.forward,
                        reverse: primer.reverse,
                        forwardTm: primer.forwardTm.toFixed(2),
                        forwardGc: primer.forwardGc.toFixed(2),
                        reverseTm: primer.reverseTm.toFixed(2),
                        reverseGc: primer.reverseGc.toFixed(2),
                        length: primer.length,
                        fiveLen: primer.fiveLen,
                        threeLen: primer.threeLen,
                        mismatch: primer.mismatch,
                        originalCodon: mutation.originalCodon,
                        optimalCodon: optimalCodons[mutation.target],
                        endsWithGC: /[CG]$/.test(primer.forward) && /[CG]$/.test(primer.reverse)
                    });
                    
                    successCount++;
                }
            }
            
            // 隐藏加载动画
            document.getElementById('loading').style.display = 'none';
            
            // 显示结果
            displayResults();
            
            // 显示成功信息
            if (successCount > 0) {
                showSuccess(`成功设计 ${successCount} 个突变体的引物`);
                document.getElementById('download-btn').disabled = false;
            } else {
                showError('所有突变体引物设计失败');
            }
        }
        
        // 显示结果
        function displayResults() {
            const resultBox = document.getElementById('result-box');
            const content = document.getElementById('result-content');
            
            if (primerResults.length === 0) {
                content.innerHTML = '<p>没有设计结果</p>';
            } else {
                let html = '<h3>引物设计结果</h3>';
                
                html += `
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>突变体名称</th>
                                <th>上游引物 (5\'→3\')</th>
                                <th>下游引物 (5\'→3\')</th>
                                <th>上游参数</th>
                                <th>下游参数</th>
                                <th>其他信息</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                for (const result of primerResults) {
                    if (result.error) {
                        html += `
                            <tr style="background-color: #ffebee;">
                                <td><strong>${result.name}</strong></td>
                                <td colspan="5" style="color: #d32f2f;">${result.error}</td>
                            </tr>
                        `;
                    } else {
                        const forwardEndsWithGC = /[CG]$/.test(result.forward) ? '含C/G' : '不含C/G';
                        const reverseEndsWithGC = /[CG]$/.test(result.reverse) ? '含C/G' : '不含C/G';
                        
                        html += `
                            <tr>
                                <td><strong>${result.name}</strong></td>
                                <td><span class="primer-sequence">${result.forward}</span></td>
                                <td><span class="primer-sequence">${result.reverse}</span></td>
                                <td>
                                    <div class="primer-param">Tm: ${result.forwardTm}°C</div>
                                    <div class="primer-param">GC: ${result.forwardGc}%</div>
                                    <div class="primer-param">长度: ${result.length} bp</div>
                                    <div class="primer-param">末端: ${forwardEndsWithGC}</div>
                                </td>
                                <td>
                                    <div class="primer-param">Tm: ${result.reverseTm}°C</div>
                                    <div class="primer-param">GC: ${result.reverseGc}%</div>
                                    <div class="primer-param">长度: ${result.length} bp</div>
                                    <div class="primer-param">末端: ${reverseEndsWithGC}</div>
                                </td>
                                <td>
                                    <div class="primer-param">5'端: ${result.fiveLen} bp</div>
                                    <div class="primer-param">3'端: ${result.threeLen} bp</div>
                                    <div class="primer-param">不匹配: ${result.mismatch}</div>
                                    <div class="primer-param">原密码子: ${result.originalCodon}</div>
                                    <div class="primer-param">优密码子: ${result.optimalCodon}</div>
                                </td>
                            </tr>
                        `;
                    }
                }
                
                html += `
                        </tbody>
                    </table>
                `;
                
                content.innerHTML = html;
            }
            
            resultBox.style.display = 'block';
        }
        
        // 下载结果 - 只包含三列
        function downloadResults() {
            if (primerResults.length === 0) {
                showError('没有可下载的结果');
                return;
            }
            
            // 准备数据 - 只包含三列：突变体名称、上游引物、下游引物
            const wsData = [
                ['突变体名称', '上游引物 (5\'-3\')', '下游引物 (5\'-3\')']
            ];
            
            for (const result of primerResults) {
                if (!result.error) {
                    wsData.push([
                        result.name,
                        result.forward,
                        result.reverse
                    ]);
                }
            }
            
            // 创建工作簿和工作表
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // 设置列宽
            const wscols = [
                {wch: 15}, // 突变体名称
                {wch: 40}, // 上游引物
                {wch: 40}  // 下游引物
            ];
            ws['!cols'] = wscols;
            
            // 添加工作表到工作簿
            XLSX.utils.book_append_sheet(wb, ws, '引物设计结果');
            
            // 生成文件名
            const fileName = `大肠杆菌突变引物_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            // 下载文件
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>
