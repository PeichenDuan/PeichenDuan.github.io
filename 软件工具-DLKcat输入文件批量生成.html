<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLKcat输入文件批量生成</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --protein-protein-color: #9b59b6;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* 顶部标题栏 */
        .tool-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            width: 100%;
            text-align: center;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            margin-top: 15px;
            text-decoration: none;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* 内容区域样式 */
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        h2 {
            color: var(--primary-color);
            text-align: center;
        }

        h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* 模式选择器样式 - 与Amber24一致 */
        .mode-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        .mode-option {
            flex: 1;
            padding: 12px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid #ddd;
        }

        .mode-option:not(:last-child) {
            border-right: none;
        }

        .mode-option.active {
            color: white;
        }

        .mode-option[data-function="mutation"].active {
            background-color: var(--secondary-color);
        }

        .mode-option[data-function="free-edit"].active {
            background-color: var(--warning-color);
        }

        .mode-option:hover:not(.active) {
            background-color: #e9ecef;
        }

        /* 突变类型选择样式 - 与顶部区分开 */
        .mutation-type-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .mutation-type-option {
            padding: 12px 24px;
            background-color: #f1f1f1;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            text-align: center;
            flex: 1;
            max-width: 200px;
        }

        .mutation-type-option.active {
            background-color: var(--success-color);
            color: white;
        }

        /* 按钮样式 */
        .generate-button {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: var(--success-color);
            color: white;
            font-weight: bold;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
            margin-top: 20px;
        }

        .generate-button:hover {
            background-color: #219955;
        }

        .generate-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        /* 结果区域样式 */
        .result-box {
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            margin-top: 15px;
            border-left: 4px solid var(--secondary-color);
            display: none;
        }

        .download-link {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: var(--border-radius);
            text-decoration: none;
            margin-top: 10px;
            transition: var(--transition);
        }

        .download-link:hover {
            background-color: #2980b9;
        }

        /* 隐藏类 */
        .hidden {
            display: none;
        }

        /* 状态栏样式 */
        .status-bar {
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
        }

        /* 氨基酸示例样式 */
        .amino-acids {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .amino-acid {
            padding: 5px 10px;
            background-color: #e9f7fe;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* 自由编辑表格样式 */
        .enzyme-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .enzyme-table th, .enzyme-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .enzyme-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }

        .enzyme-table input {
            width: 100%;
            border: none;
            padding: 5px;
            font-size: 14px;
        }

        .enzyme-table input:focus {
            outline: 1px solid var(--secondary-color);
        }

        .add-row-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            cursor: pointer;
            margin-top: 10px;
            transition: var(--transition);
        }

        .add-row-btn:hover {
            background-color: #2980b9;
        }

        .delete-row-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .mode-selector {
                flex-direction: column;
            }
            
            .mode-option:not(:last-child) {
                border-right: 1px solid #ddd;
                border-bottom: none;
            }
            
            .mutation-type-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .mutation-type-option {
                max-width: 100%;
            }
            
            .amino-acids {
                justify-content: center;
            }
            
            .enzyme-table {
                font-size: 14px;
            }
            
            .enzyme-table th, .enzyme-table td {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="tool-header">
        <h2 style="color: white;">DLKcat输入文件批量生成</h2>
        <a href="index.html" class="back-button">返回主界面</a>
    </div>
    
    <div class="content">
        <div class="section">
            <h2>输入文件批量生成</h2>
            
            <!-- 功能选择部分 - 使用与Amber24相同的样式 -->
            <div class="form-group">
                <label>选择功能:</label>
                <div class="mode-selector">
                    <div class="mode-option active" data-function="mutation">酶突变序列生成</div>
                    <div class="mode-option" data-function="free-edit">自由编辑酶-底物组合</div>
                </div>
            </div>
            
            <!-- 酶突变序列生成部分 -->
            <div id="mutation-section">
                <div class="form-group">
                    <label for="enzyme-sequence">酶序列:</label>
                    <input type="text" id="enzyme-sequence" placeholder="请输入原始序列（例如：MASNDYTQQ...）">
                </div>
                
                <div class="form-group">
                    <label for="substrate-smiles">底物SMILES号:</label>
                    <input type="text" id="substrate-smiles" placeholder="输入您的底物SMILES号">
                </div>
                
                <div class="form-group">
                    <label>突变类型:</label>
                    <div class="mutation-type-selector">
                        <div class="mutation-type-option active" data-mutation-type="saturation">饱和突变</div>
                        <div class="mutation-type-option" data-mutation-type="random">随机位点突变</div>
                    </div>
                </div>
                
                <!-- 饱和突变部分 -->
                <div id="saturation-section" class="form-group">
                    <label for="saturation-sites">饱和突变位点:</label>
                    <input type="text" id="saturation-sites" placeholder="输入您想进行饱和突变的位点，用空格分隔（例如：V500 S516-V529）">
                    <p><small>支持单个位点（如V500）和连续位点范围（如S516-V529），每个位点将生成19种突变体（排除原始氨基酸）</small></p>
                </div>
                
                <!-- 随机位点突变部分 -->
                <div id="random-section" class="form-group hidden">
                    <label for="random-mutations">随机位点突变:</label>
                    <textarea id="random-mutations" placeholder="输入你想突变的位点及新氨基酸，不同突变可用空格或换行分隔（例如：S516M S517A）"></textarea>
                    <p><small>格式：原始氨基酸+位置+新氨基酸，例如：S516M</small></p>
                </div>
                
                <button id="generate-mutation-button" class="generate-button">生成突变序列</button>
            </div>
            
            <!-- 自由编辑序列-底物组合部分 -->
            <div id="free-edit-section" class="hidden">
                <div class="form-group">
                    <label>酶-底物组合列表:</label>
                    <table class="enzyme-table">
                        <thead>
                            <tr>
                                <th>酶名称</th>
                                <th>底物SMILES号</th>
                                <th>酶序列</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="enzyme-table-body">
                            <tr>
                                <td><input type="text" placeholder="例如：WT"></td>
                                <td><input type="text" placeholder="例如：C1=CC=CC=C1"></td>
                                <td><input type="text" placeholder="例如：MASNDYTQQ..."></td>
                                <td><button class="delete-row-btn">×</button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button id="add-row-btn" class="add-row-btn">添加一行</button>
                </div>
                
                <button id="generate-free-edit-button" class="generate-button">生成输入文件</button>
            </div>
            
            <div id="result-box" class="result-box">
                <!-- 生成结果将在这里显示 -->
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        江南大学 粮食发酵工艺与技术国家工程实验室
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 主功能选择
            const functionOptions = document.querySelectorAll('.mode-option[data-function]');
            const mutationSection = document.getElementById('mutation-section');
            const freeEditSection = document.getElementById('free-edit-section');
            
            functionOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // 移除所有选项的active类
                    functionOptions.forEach(opt => opt.classList.remove('active'));
                    // 添加当前选项的active类
                    this.classList.add('active');
                    
                    // 显示对应的功能部分
                    const functionType = this.getAttribute('data-function');
                    if (functionType === 'mutation') {
                        mutationSection.classList.remove('hidden');
                        freeEditSection.classList.add('hidden');
                    } else {
                        mutationSection.classList.add('hidden');
                        freeEditSection.classList.remove('hidden');
                    }
                });
            });
            
            // 突变类型选择
            const mutationTypeOptions = document.querySelectorAll('.mutation-type-option[data-mutation-type]');
            const saturationSection = document.getElementById('saturation-section');
            const randomSection = document.getElementById('random-section');
            
            mutationTypeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // 移除所有选项的active类
                    mutationTypeOptions.forEach(opt => opt.classList.remove('active'));
                    // 添加当前选项的active类
                    this.classList.add('active');
                    
                    // 显示对应的功能部分
                    const mutationType = this.getAttribute('data-mutation-type');
                    if (mutationType === 'saturation') {
                        saturationSection.classList.remove('hidden');
                        randomSection.classList.add('hidden');
                    } else {
                        saturationSection.classList.add('hidden');
                        randomSection.classList.remove('hidden');
                    }
                });
            });
            
            // 定义所有20种氨基酸
            const aminoAcids = ['G', 'A', 'V', 'L', 'I', 'S', 'T', 'C', 'M', 'D', 'E', 'N', 'Q', 'K', 'R', 'H', 'F', 'Y', 'W', 'P'];
            
            // 解析位点输入，支持单个位点和连续范围
            function parseMutationSites(input, enzymeSequence) {
                const sites = [];
                const tokens = input.split(/\s+/);
                
                for (const token of tokens) {
                    if (!token) continue;
                    
                    // 检查是否是连续位点范围（如 S516-V529）
                    const rangeMatch = token.match(/^([A-Z])(\d+)-([A-Z])(\d+)$/);
                    if (rangeMatch) {
                        const startAA = rangeMatch[1];
                        const startPos = parseInt(rangeMatch[2]);
                        const endAA = rangeMatch[3];
                        const endPos = parseInt(rangeMatch[4]);
                        
                        // 验证位置是否有效
                        if (startPos >= endPos) {
                            throw new Error(`连续位点范围的起始位置必须小于结束位置: ${token}`);
                        }
                        
                        // 验证位置是否在序列范围内
                        if (startPos < 1 || endPos > enzymeSequence.length) {
                            throw new Error(`连续位点范围超出序列范围: ${token} (序列长度: ${enzymeSequence.length})`);
                        }
                        
                        // 生成范围内的所有位点
                        for (let pos = startPos; pos <= endPos; pos++) {
                            const originalAA = enzymeSequence[pos-1];
                            sites.push(`${originalAA}${pos}`);
                        }
                    } else {
                        // 单个位点
                        sites.push(token);
                    }
                }
                
                return sites;
            }
            
            // 生成突变序列
            const generateMutationButton = document.getElementById('generate-mutation-button');
            const resultBox = document.getElementById('result-box');
            
            generateMutationButton.addEventListener('click', function() {
                // 获取用户输入
                const enzymeSequence = document.getElementById('enzyme-sequence').value.trim().toUpperCase();
                const substrateSmiles = document.getElementById('substrate-smiles').value.trim();
                const isSaturation = document.querySelector('.mutation-type-option[data-mutation-type].active').getAttribute('data-mutation-type') === 'saturation';
                
                // 验证输入
                if (!enzymeSequence) {
                    alert('请输入酶序列');
                    return;
                }
                
                if (!substrateSmiles) {
                    alert('请输入底物SMILES号');
                    return;
                }
                
                // 禁用按钮，显示处理中
                generateMutationButton.disabled = true;
                generateMutationButton.textContent = '处理中...';
                
                try {
                    let output = "Substrate Name\tSubstrate SMILES\tProtein Sequence\n";
                    output += `WT\t${substrateSmiles}\t${enzymeSequence}\n`;
                    
                    if (isSaturation) {
                        // 饱和突变处理
                        const saturationSitesInput = document.getElementById('saturation-sites').value.trim();
                        if (!saturationSitesInput) {
                            throw new Error('请输入饱和突变位点');
                        }
                        
                        // 解析位点输入（支持单个位点和连续范围）
                        const saturationSites = parseMutationSites(saturationSitesInput, enzymeSequence);
                        
                        // 验证每个位点格式并生成突变
                        for (const site of saturationSites) {
                            if (site.length < 2) {
                                throw new Error(`位点格式错误: ${site}`);
                            }
                            
                            const originalAA = site[0].toUpperCase();
                            const positionStr = site.substring(1);
                            const position = parseInt(positionStr);
                            
                            if (isNaN(position) || position < 1 || position > enzymeSequence.length) {
                                throw new Error(`位点位置无效: ${site} (序列长度: ${enzymeSequence.length})`);
                            }
                            
                            // 检查原始氨基酸是否匹配
                            const actualAA = enzymeSequence[position-1];
                            if (actualAA !== originalAA) {
                                alert(`警告: 序列中位置${position}的氨基酸是${actualAA}，不是${originalAA}。将使用实际氨基酸${actualAA}进行突变。`);
                            }
                            
                            // 为每个位点生成所有可能的突变
                            for (const aa of aminoAcids) {
                                if (aa !== actualAA) {
                                    const mutatedSequence = enzymeSequence.substring(0, position-1) + aa + enzymeSequence.substring(position);
                                    const mutationFormula = `${actualAA}${position}${aa}`;
                                    output += `${mutationFormula}\t${substrateSmiles}\t${mutatedSequence}\n`;
                                }
                            }
                        }
                    } else {
                        // 随机位点突变处理
                        const randomMutationsInput = document.getElementById('random-mutations').value.trim();
                        if (!randomMutationsInput) {
                            throw new Error('请输入随机位点突变');
                        }
                        
                        const randomMutations = randomMutationsInput.split(/\s+/);
                        
                        // 验证每个突变格式并生成突变序列
                        for (const mutation of randomMutations) {
                            if (mutation.length < 3) {
                                throw new Error(`突变格式错误: ${mutation}`);
                            }
                            
                            const originalAA = mutation[0].toUpperCase();
                            const newAA = mutation[mutation.length-1].toUpperCase();
                            const positionStr = mutation.substring(1, mutation.length-1);
                            const position = parseInt(positionStr);
                            
                            if (isNaN(position) || position < 1 || position > enzymeSequence.length) {
                                throw new Error(`突变位置无效: ${mutation} (序列长度: ${enzymeSequence.length})`);
                            }
                            
                            // 检查原始氨基酸是否匹配
                            const actualAA = enzymeSequence[position-1];
                            if (actualAA !== originalAA) {
                                alert(`警告: 序列中位置${position}的氨基酸是${actualAA}，不是${originalAA}。将使用实际氨基酸${actualAA}进行突变。`);
                            }
                            
                            // 生成突变序列
                            const mutatedSequence = enzymeSequence.substring(0, position-1) + newAA + enzymeSequence.substring(position);
                            output += `${actualAA}${position}${newAA}\t${substrateSmiles}\t${mutatedSequence}\n`;
                        }
                    }
                    
                    // 创建Blob对象并生成下载链接
                    const blob = new Blob([output], { type: 'text/tab-separated-values' });
                    const url = URL.createObjectURL(blob);
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = 'input.tsv';
                    downloadLink.className = 'download-link';
                    downloadLink.textContent = '下载input.tsv文件 (input.tsv)';
                    
                    resultBox.innerHTML = '<h3>输入文件input.tsv已生成！</h3><p>点击下方链接下载文件：</p>';
                    resultBox.appendChild(downloadLink);
                    resultBox.style.display = 'block';
                    
                } catch (error) {
                    console.error('生成input.tsv时出错:', error);
                    resultBox.innerHTML = `<p>生成input.tsv时出错: ${error.message}</p>`;
                    resultBox.style.display = 'block';
                } finally {
                    // 恢复按钮状态
                    generateMutationButton.disabled = false;
                    generateMutationButton.textContent = '生成突变序列';
                }
            });
            
            // 自由编辑功能
            const enzymeTableBody = document.getElementById('enzyme-table-body');
            const addRowBtn = document.getElementById('add-row-btn');
            const generateFreeEditButton = document.getElementById('generate-free-edit-button');
            
            // 添加新行
            addRowBtn.addEventListener('click', function() {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="text" placeholder="例如：WT"></td>
                    <td><input type="text" placeholder="例如：C1=CC=CC=C1"></td>
                    <td><input type="text" placeholder="例如：MASNDYTQQ..."></td>
                    <td><button class="delete-row-btn">×</button></td>
                `;
                enzymeTableBody.appendChild(newRow);
                
                // 为新行的删除按钮添加事件监听器
                newRow.querySelector('.delete-row-btn').addEventListener('click', function() {
                    enzymeTableBody.removeChild(newRow);
                });
            });
            
            // 为初始行的删除按钮添加事件监听器
            document.querySelector('.delete-row-btn').addEventListener('click', function() {
                const row = this.closest('tr');
                // 如果表格中只有一行，则不清除，而是重置输入
                if (enzymeTableBody.children.length === 1) {
                    const inputs = row.querySelectorAll('input');
                    inputs.forEach(input => input.value = '');
                } else {
                    enzymeTableBody.removeChild(row);
                }
            });
            
            // 生成自由编辑输入文件
            generateFreeEditButton.addEventListener('click', function() {
                // 禁用按钮，显示处理中
                generateFreeEditButton.disabled = true;
                generateFreeEditButton.textContent = '处理中...';
                
                try {
                    let output = "Substrate Name\tSubstrate SMILES\tProtein Sequence\n";
                    const rows = enzymeTableBody.querySelectorAll('tr');
                    
                    // 验证并收集数据
                    for (const row of rows) {
                        const inputs = row.querySelectorAll('input');
                        const enzymeName = inputs[0].value.trim();
                        const substrateSmiles = inputs[1].value.trim();
                        const enzymeSequence = inputs[2].value.trim();
                        
                        if (!enzymeName) {
                            throw new Error('请填写所有酶名称');
                        }
                        
                        if (!substrateSmiles) {
                            throw new Error('请填写所有底物SMILES号');
                        }
                        
                        if (!enzymeSequence) {
                            throw new Error('请填写所有酶序列');
                        }
                        
                        output += `${enzymeName}\t${substrateSmiles}\t${enzymeSequence}\n`;
                    }
                    
                    // 创建Blob对象并生成下载链接
                    const blob = new Blob([output], { type: 'text/tab-separated-values' });
                    const url = URL.createObjectURL(blob);
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = 'input.tsv';
                    downloadLink.className = 'download-link';
                    downloadLink.textContent = '下载input.tsv文件 (input.tsv)';
                    
                    resultBox.innerHTML = '<h3>输入文件input.tsv已生成！</h3><p>点击下方链接下载文件：</p>';
                    resultBox.appendChild(downloadLink);
                    resultBox.style.display = 'block';
                    
                } catch (error) {
                    console.error('生成input.tsv时出错:', error);
                    resultBox.innerHTML = `<p>生成input.tsv时出错: ${error.message}</p>`;
                    resultBox.style.display = 'block';
                } finally {
                    // 恢复按钮状态
                    generateFreeEditButton.disabled = false;
                    generateFreeEditButton.textContent = '生成输入文件';
                }
            });
        });
    </script>
</body>
</html>
